@using Final_ShoppingOnline.Models.Models.ProductModel
@model IEnumerable<ProductModel>

@{
    ViewData["Title"] = "List Product";
}

<!--Breadcrumb đã hoàn thành-->
<div class="breadcrumb_section">
    <div class="container">
        <ul class="breadcrumb_nav ul_li">
            <li><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li>Listed Product</li>
        </ul>
    </div>
</div>


<section class="product_section section_space">
    <div class="container">
        <div class="row">
            <div class="col-lg-9">
                <div class="filter_topbar">
                    <div class="row align-items-center">
                        <!--Button Layout ổn-->
                        <div class="col col-md-4 col-sm-4">
                            <ul class="layout_btns nav" role="tablist">
                                <li role="presentation">
                                    <button class="active" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                                        <i class="fal fa-bars"></i>
                                    </button>
                                </li>
                                <li role="presentation">
                                    <button data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">
                                        <i class="fal fa-th-large"></i>
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <!---->
                        <div class="col col-md-4 col-sm-4">
                            <form asp-action="SortByName" asp-controller="Product" method="get">
                                <div class="select_option clearfix">
                                    <select name="sortOrder" id="sortOrder">
                                        <option data-display="Defaul Sorting" value="">Select Your Option</option>
                                        @if (ViewBag.SortOrder == "name")
                                        {
                                            <option value="name" selected>Sort By Name</option>
                                        }
                                        else
                                        {
                                            <option value="name">Sort By Name</option>
                                        }
                                        @if (ViewBag.SortOrder == "price")
                                        {
                                            <option value="price" selected>Sort By Price</option>
                                        }
                                        else
                                        {
                                            <option value="price">Sort By Price</option>
                                        }
                                    </select>
                                </div>
                                <input type="hidden" name="categoryId" value="@ViewBag.CategoryId" />
                                <input type="hidden" name="brandId" value="@ViewBag.BrandId" />
                                <input type="hidden" name="memoryFilter" value="@ViewBag.MemoryFilter" />
                                <button type="submit" class="btn btn-primary">Sort</button>
                            </form>
                        </div>

                        <!--Chức năng OK-->
                        <div class="col col-md-4 col-sm-4">
                            <div class="result_text">Showing 1-12 of @Model.Count() results</div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="home" role="tabpanel">
                        <div class="product_wrap">
                            @foreach (var product in Model)
                            {
                                <div class="product_layout1">
                                    @if (product.IsOnSale)
                                    {
                                        <div class="item_badge hot_badge">
                                            <span>HOT</span>
                                        </div>
                                    }
                                    <div class="item_image">
                                        <img src="~/Images/Products/@product.ImageUrl" alt="@product.Name">
                                        <img src="~/Images/Products/@product.HoverImageUrl" alt="@product.Name">
                                        <a class="quickview_btn" data-bs-toggle="modal" data-bs-target="#quickview_popup" role="button"
                                           data-product-id="@product.Id">Quick View</a>
                                    </div>
                                    <div class="item_content">
                                        <h3 class="item_title">
                                            <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">@product.Name</a>
                                        </h3>
                                        <ul class="rating_star ul_li">
                                            @for (int i = 0; i < product.StarRating; i++)
                                            {
                                                <li><i class="fa-solid fa-star"></i></li>
                                            }
                                            @for (int i = product.StarRating; i < 5; i++)
                                            {
                                                <li><i class="fa-regular fa-star"></i></li>
                                            }
                                        </ul>
                                        <div class="item_price">
                                            <span>@product.SalePrice.ToString("C")</span>
                                            <del>@product.Price.ToString("C")</del>
                                        </div>
                                        <ul class="item_btns_group ul_li">
                                            <li><a class="addtocart_btn" asp-controller="Cart" asp-action="AddToCart" asp-route-id="@product.Id">Add To Cart</a></li>
                                            <li><a asp-controller="Compare" asp-action="AddToCompare"><i class="fa-solid fa-arrows-rotate"></i></a></li>
                                            <li><a asp-controller="WishList" asp-action="AddToWishList"><i class="fas fa-heart"></i></a></li>
                                        </ul>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="pagination_wrap">
                            <ul class="pagination_nav ul_li_right">
                                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                {
                                    <li class="@(i == ViewBag.CurrentPage ? "active" : "")"><a asp-action="Index" asp-controller="Product" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-memoryFilter="@ViewBag.MemoryFilter" asp-route-sortOrder="@ViewBag.SortOrder" asp-route-page="@i">@i</a></li>
                                }
                                <li class="prev_btn"><a asp-action="Previous" asp-controller="Product" asp-route-page="@(ViewBag.CurrentPage - 1)" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-memoryFilter="@ViewBag.MemoryFilter" asp-route-sortOrder="@ViewBag.SortOrder"><i class="fa-regular fa-angle-left"></i></a></li>
                                <li class="next_btn"><a asp-action="Next" asp-controller="Product" asp-route-page="@(ViewBag.CurrentPage + 1)" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-memoryFilter="@ViewBag.MemoryFilter" asp-route-sortOrder="@ViewBag.SortOrder"><i class="fa-regular fa-angle-right"></i></a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="profile" role="tabpanel">
                        <div class="product_layout2_wrap">
                            @foreach (var product in Model)
                            {
                                <div class="product_layout2">
                                    <div class="item_image">
                                        @if (product.IsOnSale)
                                        {
                                            <div class="item_badge hot_badge">
                                                <span>SALE</span>
                                            </div>
                                        }
                                        <a class="image_wrap" asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">
                                            <img src="~/Images/Products/@product.ImageUrl" alt="@product.Name">
                                        </a>
                                    </div>
                                    <div class="item_content">
                                        <h3 class="item_title">
                                            <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">@product.Name</a>
                                        </h3>
                                        <ul class="rating_star ul_li">
                                            @for (int i = 0; i < product.StarRating; i++)
                                            {
                                                <li><i class="fa-solid fa-star"></i></li>
                                            }
                                            @for (int i = product.StarRating; i < 5; i++)
                                            {
                                                <li><i class="fa-regular fa-star"></i></li>
                                            }
                                        </ul>
                                        <p>
                                            @product.Description
                                        </p>
                                        <div class="item_price">
                                            <span>@product.SalePrice.ToString("C")</span>
                                            <del>@product.Price.ToString("C")</del>
                                        </div>
                                        <ul class="item_btns_group ul_li">
                                            <li><a class="addtocart_btn" asp-controller="Cart" asp-action="AddToCart" asp-route-id="@product.Id">Add To Cart</a></li>
                                            <li><a asp-controller="Compare" asp-action="AddToCompare"><i class="fa-solid fa-arrows-rotate"></i></a></li>
                                            <li><a asp-controller="WishList" asp-action="AddToWishList"><i class="fas fa-heart"></i></a></li>
                                        </ul>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="pagination_wrap">
                            <ul class="pagination_nav ul_li_right">
                                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                {
                                    <li class="@(i == ViewBag.CurrentPage ? "active" : "")"><a asp-action="Index" asp-controller="Product" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-memoryFilter="@ViewBag.MemoryFilter" asp-route-sortOrder="@ViewBag.SortOrder" asp-route-page="@i">@i</a></li>
                                }
                                <li class="prev_btn"><a asp-action="Previous" asp-controller="Product" asp-route-page="@(ViewBag.CurrentPage - 1)" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-memoryFilter="@ViewBag.MemoryFilter" asp-route-sortOrder="@ViewBag.SortOrder"><i class="fa-regular fa-angle-left"></i></a></li>
                                <li class="next_btn"><a asp-action="Next" asp-controller="Product" asp-route-page="@(ViewBag.CurrentPage + 1)" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-memoryFilter="@ViewBag.MemoryFilter" asp-route-sortOrder="@ViewBag.SortOrder"><i class="fa-regular fa-angle-right"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 order-lg-first">
                <aside class="sidebar_section ps-0 mt-lg-0">
                    <div class="sb_widget sb_category">
                        <h3 class="sb_widget_title">Categories</h3>
                        <ul class="sb_category_list ul_li_block">
                            @foreach (var category in ViewBag.Categories)
                            {
                                <li><a asp-controller="Product" asp-action="Index" asp-route-categoryId="@category.Id">@category.Name</a></li>
                            }
                        </ul>
                    </div>

                    <div class="sb_widget sb_category">
                        <h3 class="sb_widget_title">Brands</h3>
                        <ul class="sb_category_list ul_li_block">
                            @foreach (var brand in ViewBag.Brands)
                            {
                                <li><a asp-controller="Product" asp-action="Index" asp-route-brandId="@brand.Id">@brand.Name</a></li>
                            }
                        </ul>
                    </div>

                    <div class="sb_widget">
                        <h3 class="sb_widget_title">Your Filter</h3>
                        <div class="filter_sidebar">
                            <div class="fs_widget">
                                <h3 class="fs_widget_title">Category</h3>
                                <form action="#">
                                    <div class="select_option clearfix">
                                        <select id="categoryFilter">
                                            <option data-display="Select Category">Select Your Option</option>
                                            @foreach (var category in ViewBag.Categories)
                                            {
                                                <option value="@category.Id" selected="@(category.Id == ViewBag.CategoryId ? "selected" : "")">@category.Name</option>
                                            }
                                        </select>
                                    </div>
                                </form>
                            </div>

                            <div class="fs_widget">
                                <h3 class="fs_widget_title">Brand</h3>
                                <form action="#">
                                    <ul class="fs_brand_list ul_li_block">
                                        @foreach (var brand in ViewBag.Brands)
                                        {
                                            <li>
                                                <div class="checkbox_item">
                                                    <input id="@brand.Id" type="checkbox" name="brand_checkbox">
                                                    <label for="@brand.Id">@brand.Name</label>
                                                </div>
                                            </li>
                                        }
                                    </ul>
                                </form>
                            </div>

                            <div class="fs_widget">
                                <h3 class="fs_widget_title">Price</h3>
                                <form action="#">
                                    <div class="price-range-area clearfix">
                                        <div class="price-text d-flex align-items-center">
                                            <span>Range:</span>
                                            <input type="text" id="amount" readonly>
                                        </div>
                                        <div id="slider-range" class="slider-range"></div>
                                    </div>
                                </form>
                            </div>

                            <div class="fs_widget">
                                <h3 class="fs_widget_title">Average Rating</h3>
                                <ul class="average_rating_list ul_li_block">
                                    @for (int i = 5; i > 0; i--)
                                    {
                                        <li>
                                            @for (int j = 0; j < i; j++)
                                            {
                                                <i class="fas fa-star"></i>
                                            }
                                            @for (int j = i; j < 5; j++)
                                            {
                                                <i class="far fa-star"></i>
                                            }
                                            <span>(@Model.Where(p => p.StarRating == i).Count())</span>
                                        </li>
                                    }
                                </ul>
                            </div>

                            <div class="fs_widget">
                                <h3 class="fs_widget_title">Filter by Memory</h3>
                                <ul class="filter_memory_list ul_li_block">
                                    @foreach (var option in ViewBag.MemoryFilters)
                                    {
                                        <li>
                                            <div class="checkbox_item">
                                                <input type="checkbox" name="memoryFilter" value="@option.Value">
                                                <label for="@option.Value">@option.Value</label>
                                            </div>
                                        </li>
                                    }
                                </ul>
                                <button type="button" class="btn btn-primary" onclick="filterProducts()">Filter</button>
                                <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                            </div>
                        </div>
                    </div>

                    <div class="sb_widget latest_product_carousel mb-lg-0">
                        <div class="title_wrap">
                            <h3 class="area_title">Latest Products</h3>
                            <div class="carousel_nav">
                                <button type="button" class="vs4i_left_arrow"><i class="fa-regular fa-angle-left"></i></button>
                                <button type="button" class="vs4i_right_arrow"><i class="fa-regular fa-angle-right"></i></button>
                            </div>
                        </div>
                        <div class="vertical_slider_4item" data-slick='{"dots": false}'>
                            @foreach (var product in ViewBag.LatestProducts)
                            {
                                <div class="slider_item">
                                    <div class="small_product_layout">
                                        <a class="item_image" asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">
                                            <img src="@product.ImageUrl" alt="@product.Name">
                                        </a>
                                        <div class="item_content">
                                            <h3 class="item_title">
                                                <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">@product.Name</a>
                                            </h3>
                                            <ul class="rating_star ul_li">
                                                @for (int i = 0; i < product.StarRating; i++)
                                                {
                                                    <li><i class="fa-solid fa-star"></i></li>
                                                }
                                                @for (int i = product.StarRating; i < 5; i++)
                                                {
                                                    <li><i class="fa-regular fa-star"></i></li>
                                                }
                                            </ul>
                                            <div class="item_price">
                                                <span>@product.SalePrice.ToString("C")</span>
                                                <del>@product.Price.ToString("C")</del>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="quickview_popup" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalToggleLabel2">Product Quick View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Nội dung Quick View sẽ được chèn vào đây -->
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        // Hàm hiển thị Quick View
        function showQuickView(productId) {
            // Gọi action QuickView trong controller
            $.ajax({
                url: '/Product/QuickView/' + productId,
                type: 'GET',
                success: function (data) {
                    // Cập nhật nội dung modal Quick View
                    $('#quickview_popup .modal-body').html(data);
                    // Hiển thị modal
                    $('#quickview_popup').modal('show');
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // Xử lý lỗi nếu có
                    console.error(textStatus + ': ' + errorThrown);
                }
            });
        }

        $(document).ready(function () {
            // Gắn sự kiện click vào nút Quick View
            $('.quickview_btn').click(function () {
                // Lấy productId từ thuộc tính data-product-id
                var productId = $(this).data('product-id');
                // Gọi hàm showQuickView
                showQuickView(productId);
            });

            // Initialize Price Slider
            $("#slider-range").slider({
                range: true,
                min: 0,
                max: 1000, // Thay đổi giá trị max phù hợp với phạm vi giá sản phẩm
                values: [0, 1000], // Giá trị mặc định cho slider
                slide: function (event, ui) {
                    $("#amount").val("$" + ui.values[0] + " - $" + ui.values[1]);
                }
            });
            $("#amount").val("$" + $("#slider-range").slider("values", 0) + " - $" + $("#slider-range").slider("values", 1));
        });

        // Hàm lọc sản phẩm
        function filterProducts() {
            // Lấy giá trị từ các filter
            var categoryId = $('#categoryFilter').val();
            var brandCheckbox = $('input[name="brand_checkbox"]:checked');
            var brandIds = brandCheckbox.map(function () {
                return $(this).attr('id');
            }).get();
            var minPrice = $('#slider-range').slider('values', 0);
            var maxPrice = $('#slider-range').slider('values', 1);
            var memoryFilter = $('input[name="memoryFilter"]:checked').val();

            // Tạo query string để redirect
            var queryString = "?";
            if (categoryId) {
                queryString += "categoryId=" + categoryId + "&";
            }
            if (brandIds.length > 0) {
                queryString += "brandIds=" + brandIds.join(",") + "&";
            }
            if (minPrice) {
                queryString += "minPrice=" + minPrice + "&";
            }
            if (maxPrice) {
                queryString += "maxPrice=" + maxPrice + "&";
            }
            if (memoryFilter) {
                queryString += "memoryFilter=" + memoryFilter + "&";
            }
            // Remove dấu & cuối cùng
            queryString = queryString.substring(0, queryString.length - 1);

            // Redirect đến action Index với query string
            window.location.href = "/Product/Index" + queryString;
        }

        // Hàm xóa filter
        function clearFilters() {
            // Reset các filter
            $('#categoryFilter').val("");
            $('input[name="brand_checkbox"]').prop("checked", false);
            $('#slider-range').slider('values', 0, 0);
            $('input[name="memoryFilter"]').prop("checked", false);

            // Redirect đến action Index mà không có query string
            window.location.href = "/Product/Index";
        }
    </script>
}